<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Fishdog Poops</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
            }

            /* Custom scrollbar for table and heatmap */
            .custom-scroll::-webkit-scrollbar {
                width: 6px;
            }
            .custom-scroll::-webkit-scrollbar-track {
                background: #f1f1f1;
            }
            .custom-scroll::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }
            .custom-scroll::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800 h-screen flex flex-col">
        <header class="bg-white shadow-sm z-10 p-4 border-b border-slate-200">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1
                    class="text-xl font-semibold text-slate-700 flex items-center gap-2"
                >
                    <svg
                        class="w-6 h-6 text-indigo-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0121 18.382V7.618a1 1 0 01-1.447-.894L15 7m0 13V7m0 0L9.5 4.5"
                        />
                    </svg>
                    Fishdog Poops
                </h1>
                <span
                    class="text-xs font-medium bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full"
                    id="status-badge"
                    >Loading...</span
                >
            </div>
        </header>

        <main class="flex-1 overflow-hidden">
            <div class="flex flex-col lg:flex-row h-full">
                <div
                    class="w-full lg:w-1/2 h-1/2 lg:h-full relative shadow-lg z-0"
                >
                    <div id="map" class="w-full h-full bg-slate-200"></div>
                    <div
                        id="map-loading"
                        class="absolute inset-0 flex items-center justify-center bg-white/50 backdrop-blur-sm z-10"
                    >
                        <div
                            class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"
                        ></div>
                    </div>
                </div>

                <div
                    class="w-full lg:w-1/2 h-1/2 lg:h-full bg-white flex flex-col border-l border-slate-200"
                >
                    <div
                        class="flex flex-col flex-[3] overflow-hidden border-b border-slate-200"
                    >
                        <div class="overflow-y-auto flex-1 custom-scroll p-4">
                            <table class="w-full text-sm text-left">
                                <thead
                                    class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0"
                                >
                                    <tr>
                                        <th
                                            scope="col"
                                            class="px-4 py-3 rounded-l-lg"
                                        >
                                            Time
                                        </th>
                                        <th scope="col" class="px-4 py-3">
                                            Notes
                                        </th>
                                        <th scope="col" class="px-4 py-3">
                                            Weather
                                        </th>
                                        <th
                                            scope="col"
                                            class="px-4 py-3 rounded-r-lg"
                                        >
                                            Tags
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div
                        class="flex flex-col flex-1 bg-slate-50 overflow-hidden"
                    >
                        <div
                            class="overflow-y-auto flex-1 custom-scroll p-4"
                            id="heatmap-container"
                        >
                            <div class="text-sm text-slate-400 italic">
                                Loading heatmap...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            // CONFIGURATION
            const API_URL =
                "https://epuyoluetlaqhqucndmq.supabase.co/functions/v1/list-poops";

            let map;
            let infoWindow;

            function initMap() {
                const defaultLoc = { lat: 40.778107, lng: -73.98721 };

                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 14,
                    center: defaultLoc,
                    disableDefaultUI: false,
                    zoomControl: true,
                    streetViewControl: false,
                });

                infoWindow = new google.maps.InfoWindow();
                fetchData();
            }

            async function fetchData() {
                const statusBadge = document.getElementById("status-badge");
                const loadingOverlay = document.getElementById("map-loading");

                try {
                    const response = await fetch(API_URL);
                    if (!response.ok)
                        throw new Error("Network response was not ok");
                    const data = await response.json();

                    renderData(data.rows);
                    renderHeatmap(data.rows); // <--- NEW: Generate the heatmap

                    statusBadge.textContent = "Live";
                    statusBadge.className =
                        "text-xs font-medium bg-green-100 text-green-700 px-2 py-1 rounded-full";
                } catch (error) {
                    console.error("Error fetching data:", error);
                    statusBadge.textContent = "Error";
                    statusBadge.className =
                        "text-xs font-medium bg-red-100 text-red-700 px-2 py-1 rounded-full";
                    document.getElementById("heatmap-container").innerHTML =
                        '<div class="text-sm text-red-400 italic">Failed to load heatmap data.</div>';
                } finally {
                    loadingOverlay.style.display = "none";
                }
            }

            function renderData(rows) {
                const tableBody = document.getElementById("table-body");
                const bounds = new google.maps.LatLngBounds();

                tableBody.innerHTML = "";

                rows.forEach((row) => {
                    // Prepare weather string safely
                    const weatherStr = row.weather
                        ? `${row.weather.conditions} <span class="text-xs text-slate-400">(${row.weather.feels_like})</span>`
                        : '<span class="text-slate-300">-</span>';

                    const weatherTooltip = row.weather
                        ? `<div class="mt-2 text-xs text-slate-500 border-t pt-1 flex items-center gap-1">
                         <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>
                         ${row.weather.conditions}, feels like ${row.weather.feels_like}
                       </div>`
                        : "";

                    // 1. MAP MARKERS
                    if (row.location && row.location.lat && row.location.lon) {
                        const position = {
                            lat: row.location.lat,
                            lng: row.location.lon,
                        };
                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: row.notes || "Event",
                            animation: google.maps.Animation.DROP,
                        });

                        const contentString = `
                        <div class="p-2 max-w-xs font-sans">
                            <h3 class="font-bold text-gray-800 text-sm mb-1">${formatDate(row.created_at)}</h3>
                            <p class="text-gray-600 text-sm mb-2">${row.notes || "No notes"}</p>
                            <div class="flex flex-wrap gap-1 mb-1">
                                ${row.tags.map((tag) => `<span class="px-1.5 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded">${tag}</span>`).join("")}
                            </div>
                            ${weatherTooltip}
                        </div>
                    `;

                        const openWindow = () => {
                            infoWindow.setContent(contentString);
                            infoWindow.open(map, marker);
                        };

                        marker.addListener("mouseover", openWindow);
                        marker.addListener("click", openWindow);
                        bounds.extend(position);
                    }

                    // 2. DATA TABLE
                    const tr = document.createElement("tr");
                    tr.className =
                        "bg-white border-b hover:bg-slate-50 transition duration-150";

                    tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-slate-900 whitespace-nowrap">
                        ${formatDate(row.created_at)}
                    </td>
                    <td class="px-4 py-3 text-slate-600 max-w-xs truncate" title="${row.notes || ""}">
                        ${row.notes || "-"}
                    </td>
                    <td class="px-4 py-3 text-slate-600 whitespace-nowrap">
                        ${weatherStr}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex flex-wrap gap-1">
                            ${row.tags
                                .map(
                                    (tag) => `
                                <span class="px-2 py-1 bg-indigo-50 text-indigo-600 border border-indigo-100 text-xs rounded-full">
                                    ${tag.trim()}
                                </span>
                            `,
                                )
                                .join("")}
                        </div>
                    </td>
                `;
                    tableBody.appendChild(tr);
                });

                if (rows.length > 0) {
                    map.fitBounds(bounds);
                }
            }

            // NEW: Render the daily weather heatmap below the table
            function renderHeatmap(rows) {
                const container = document.getElementById("heatmap-container");
                const dailyData = {};
                const allTemps = [];

                // 1. Group data by day, but keep ALL individual events
                rows.forEach((row) => {
                    if (!row.weather || !row.weather.feels_like) return;

                    const date = new Date(row.created_at);
                    const dateStr = date.toLocaleDateString("en-US", {
                        month: "short",
                        day: "numeric",
                    });
                    const timeStr = date.toLocaleTimeString("en-US", {
                        hour: "numeric",
                        minute: "2-digit",
                    });

                    // Extract numeric temperature
                    const tempMatch =
                        row.weather.feels_like.match(/-?\d+(\.\d+)?/);
                    if (!tempMatch) return;
                    const temp = parseFloat(tempMatch[0]);

                    if (!dailyData[dateStr]) {
                        dailyData[dateStr] = {
                            dateLabel: dateStr,
                            timestamp: date.getTime(),
                            events: [],
                        };
                    }

                    dailyData[dateStr].events.push({
                        temp: temp,
                        time: timeStr,
                        condition: row.weather.conditions,
                    });
                    allTemps.push(temp);
                });

                if (allTemps.length === 0) {
                    container.innerHTML =
                        '<div class="text-sm text-slate-400 italic">Not enough weather data to generate a heatmap.</div>';
                    return;
                }

                // 2. Sort days from oldest to newest (like a git graph)
                const sortedDays = Object.values(dailyData).sort(
                    (a, b) => a.timestamp - b.timestamp,
                );

                // 3. Find global min and max temperatures to calculate our color scale
                const minTemp = Math.min(...allTemps);
                const maxTemp = Math.max(...allTemps, 80);

                // --- GLOBAL TOOLTIP SETUP ---
                // Create a single tooltip element attached to the body so it never gets clipped
                let tooltipEl = document.getElementById(
                    "global-heatmap-tooltip",
                );
                if (!tooltipEl) {
                    tooltipEl = document.createElement("div");
                    tooltipEl.id = "global-heatmap-tooltip";
                    tooltipEl.className =
                        "fixed pointer-events-none opacity-0 transition-opacity duration-200 z-[9999] bg-slate-800 text-white text-xs rounded py-1.5 px-2.5 shadow-lg min-w-max transform -translate-x-1/2 -translate-y-full mt-[-8px]";
                    tooltipEl.innerHTML =
                        '<div id="global-heatmap-tooltip-content"></div><div class="absolute top-full left-1/2 -translate-x-1/2 border-[5px] border-transparent border-t-slate-800"></div>';
                    document.body.appendChild(tooltipEl);
                }

                // Attach a single hover listener to the container (Event Delegation)
                if (!container.dataset.listenerAttached) {
                    container.addEventListener("mouseover", (e) => {
                        const cell = e.target.closest(".heatmap-cell");
                        if (!cell) return;

                        // Inject the specific day's data into the tooltip
                        document.getElementById(
                            "global-heatmap-tooltip-content",
                        ).innerHTML = cell.dataset.tooltip;

                        // Calculate position and move the tooltip above the cell
                        const rect = cell.getBoundingClientRect();
                        tooltipEl.style.left =
                            rect.left + rect.width / 2 + "px";
                        tooltipEl.style.top = rect.top + "px";
                        tooltipEl.style.opacity = "1";
                    });

                    container.addEventListener("mouseout", (e) => {
                        const cell = e.target.closest(".heatmap-cell");
                        if (!cell) return;
                        tooltipEl.style.opacity = "0";
                    });

                    container.dataset.listenerAttached = "true";
                }

                // 4. Build the HTML Grid
                let gridHtml = '<div class="flex flex-wrap">';

                sortedDays.forEach((day) => {
                    // Build the custom HTML tooltip contents
                    let tooltipHtml =
                        '<div class="font-semibold border-b border-slate-600 pb-1 mb-1 text-center">' +
                        day.dateLabel +
                        "</div>";
                    day.events.forEach((e) => {
                        tooltipHtml +=
                            '<div class="whitespace-nowrap py-0.5 text-slate-200">• ' +
                            e.time +
                            ': <span class="text-white font-medium">' +
                            e.temp +
                            "°</span> (" +
                            e.condition +
                            ")</div>";
                    });

                    // Escape double quotes so we can safely inject the HTML into a data-attribute
                    const safeTooltip = tooltipHtml.replace(/"/g, "&quot;");

                    // Start cell wrapper (notice the 'heatmap-cell' class and 'data-tooltip' attribute)
                    let cellHtml =
                        '<div class="heatmap-cell group w-5 h-5 cursor-help transition-all duration-150 z-10 hover:scale-110" data-tooltip="' +
                        safeTooltip +
                        '">';

                    // Inner wrapper for the stripes (pointer-events-none prevents flickering when mousing over stripes)
                    cellHtml +=
                        '<div class="w-full h-full flex overflow-hidden ring-1 ring-black/5 group-hover:ring-2 group-hover:ring-slate-400 group-hover:shadow-md pointer-events-none">';

                    // Add the color stripes
                    day.events.forEach((event) => {
                        const ratio =
                            maxTemp === minTemp
                                ? 0.5
                                : (event.temp - minTemp) / (maxTemp - minTemp);
                        const hue = (1 - ratio) * 240;
                        const bgColor = "hsl(" + hue + ", 70%, 55%)";
                        cellHtml +=
                            '<div class="flex-1 h-full" style="background-color: ' +
                            bgColor +
                            '"></div>';
                    });

                    cellHtml += "</div>"; // End inner stripes wrapper
                    cellHtml += "</div>"; // End outer cell wrapper

                    gridHtml += cellHtml;
                });

                gridHtml += "</div>";
                container.innerHTML = gridHtml;
            }

            function formatDate(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString("en-US", {
                    month: "short",
                    day: "numeric",
                    hour: "numeric",
                    minute: "2-digit",
                });
            }
        </script>

        <script
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3CghrtndQKr2r9E44kpOOMC0VcwLHs8k&callback=initMap"
            async
            defer
        ></script>
    </body>
</html>
